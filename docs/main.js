class Q{canvas;ctx;currentScene=null;lastTime=0;accumulator=0;constructor(E){let M=document.getElementById(E);if(!M)throw Error(`Canvas element with id "${E}" not found`);this.canvas=M;let _=M.getContext("2d");if(!_)throw Error("Could not get 2D context");this.ctx=_}async setScene(E){this.currentScene=E,await E.create(this.ctx)}start(){this.lastTime=performance.now(),this.loop(this.lastTime)}loop=(E)=>{let M=E-this.lastTime;this.lastTime=E,this.accumulator+=M;while(this.accumulator>=33.333333333333336){if(this.currentScene)this.currentScene.update(this.ctx,33.333333333333336);this.accumulator-=33.333333333333336}requestAnimationFrame(this.loop)};getCanvas(){return this.canvas}getContext(){return this.ctx}}class Z{grassImg=null;bushesImg=null;foxImg=null;dogImg=null;chickImg=null;chickBonesImg=null;titleImg=null;cluckSound=null;barkSound=null;introSound=null;lastBarkTime=0;scale=1;offsetX=0;offsetY=0;mapCanvas=null;mapCtx=null;wallMatrix=[];cameraX=0;cameraY=0;keys=new Set;player={x:0,y:0,width:0,height:0,frame:0};npcs=[];gameStarted=!1;gameOver=!1;levelComplete=!1;loadingComplete=!1;loadingProgress=0;loadingScreenDismissed=!1;canvas=null;mouseTarget=null;isMouseDown=!1;score=0;highScore=0;level=1;lastAnimTime=0;async create(E){this.canvas=E.canvas,this.loadHighScore(),this.updateCanvasSize(),window.addEventListener("resize",()=>this.updateCanvasSize()),this.setupInput(),this.loadAssets().then(()=>{this.generateMaze(),this.initPlayer(),this.initNPCs(),this.renderMapToBuffer()})}updateCanvasSize(){if(!this.canvas)return;this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight;let E=this.canvas.width/426,M=this.canvas.height/720;this.scale=Math.min(E,M),this.offsetX=(this.canvas.width-426*this.scale)/2,this.offsetY=(this.canvas.height-720*this.scale)/2}loadHighScore(){let E=document.cookie.match(/foxHighScore=(\d+)/);if(E)this.highScore=parseInt(E[1],10)}saveHighScore(){let E=new Date;E.setFullYear(E.getFullYear()+1),document.cookie=`foxHighScore=${this.highScore};expires=${E.toUTCString()};path=/`}setupInput(){window.addEventListener("keydown",(M)=>{if(this.keys.add(M.key),M.key===" "){if(!this.loadingScreenDismissed&&this.loadingComplete){if(this.loadingScreenDismissed=!0,this.introSound)this.introSound.currentTime=0,this.introSound.play()}else if(!this.gameStarted&&this.loadingScreenDismissed)this.startGame();else if(this.gameOver)this.restartGame();else if(this.levelComplete)this.nextLevel()}}),window.addEventListener("keyup",(M)=>{this.keys.delete(M.key)});let E=(M,_)=>{if(!this.canvas)return null;let S=this.canvas.getBoundingClientRect(),A=(M-S.left)*(this.canvas.width/S.width),F=(_-S.top)*(this.canvas.height/S.height),f=(A-this.offsetX)/this.scale,D=(F-this.offsetY)/this.scale;return{x:f+this.cameraX,y:D+this.cameraY}};this.canvas?.addEventListener("mousedown",(M)=>{if(!this.loadingScreenDismissed&&this.loadingComplete){if(this.loadingScreenDismissed=!0,this.introSound)this.introSound.currentTime=0,this.introSound.play();return}if(!this.gameStarted){this.startGame();return}if(this.gameOver){this.restartGame();return}if(this.levelComplete){this.nextLevel();return}this.isMouseDown=!0,this.mouseTarget=E(M.clientX,M.clientY)}),this.canvas?.addEventListener("mousemove",(M)=>{if(this.isMouseDown&&!this.gameOver)this.mouseTarget=E(M.clientX,M.clientY)}),window.addEventListener("mouseup",()=>{this.isMouseDown=!1}),this.canvas?.addEventListener("touchstart",(M)=>{if(M.preventDefault(),!this.loadingScreenDismissed&&this.loadingComplete){if(this.loadingScreenDismissed=!0,this.introSound)this.introSound.currentTime=0,this.introSound.play();return}if(!this.gameStarted){this.startGame();return}if(this.gameOver){this.restartGame();return}if(this.levelComplete){this.nextLevel();return}let _=M.touches[0];this.isMouseDown=!0,this.mouseTarget=E(_.clientX,_.clientY)}),this.canvas?.addEventListener("touchmove",(M)=>{if(this.isMouseDown&&!this.gameOver){M.preventDefault();let _=M.touches[0];this.mouseTarget=E(_.clientX,_.clientY)}}),window.addEventListener("touchend",()=>{this.isMouseDown=!1})}startGame(){if(this.gameStarted=!0,this.introSound)this.introSound.pause(),this.introSound.currentTime=0}restartGame(){if(this.gameOver=!1,this.levelComplete=!1,this.score=0,this.level=1,this.npcs=[],this.generateMaze(),this.initPlayer(),this.initNPCs(),this.renderMapToBuffer(),this.introSound)this.introSound.pause(),this.introSound.currentTime=0}nextLevel(){this.levelComplete=!1,this.level++,this.npcs=[],this.generateMaze(),this.initPlayer(),this.initNPCs(),this.renderMapToBuffer()}getSpeedMultiplier(){return Math.pow(1.1,this.level-1)}async loadImage(E){let _=await(await fetch(E)).blob();return createImageBitmap(_,{premultiplyAlpha:"premultiply"})}async loadAssets(){let E=["assets/plain_grass.png","assets/bushes.png","assets/fox-sprite.png","assets/dog-sprite.png","assets/chick-sprite.png","assets/chick-bones.png","assets/title.png"],M=E.length+3,_=0,S=(F)=>new Promise((f)=>setTimeout(f,F)),A=async()=>{_++,this.loadingProgress=_/M,await S(100)};this.grassImg=await this.loadImage(E[0]),await A(),this.bushesImg=await this.loadImage(E[1]),await A(),this.foxImg=await this.loadImage(E[2]),await A(),this.dogImg=await this.loadImage(E[3]),await A(),this.chickImg=await this.loadImage(E[4]),await A(),this.chickBonesImg=await this.loadImage(E[5]),await A(),this.titleImg=await this.loadImage(E[6]),await A(),this.cluckSound=new Audio("assets/cluck.mp3"),this.cluckSound.preload="auto",this.cluckSound.load(),await A(),this.barkSound=new Audio("assets/bark.mp3"),this.barkSound.preload="auto",this.barkSound.load(),await A(),this.introSound=new Audio("assets/intro.mp3"),this.introSound.preload="auto",this.introSound.loop=!0,this.introSound.load(),await A(),this.loadingComplete=!0}playerOnLeft=!0;initPlayer(){if(!this.foxImg)return;this.player.width=120,this.player.height=120,this.player.frame=Math.floor(Math.random()*2),this.lastAnimTime=performance.now(),this.playerOnLeft=Math.random()<0.5;let E=Math.floor(3.6666666666666665),M,_;if(this.playerOnLeft)M=0,_=E;else M=11-E-1,_=10;for(let S=0;S<50;S++){let A=M+Math.floor(Math.random()*(_-M+1)),F=Math.floor(Math.random()*6);if(this.wallMatrix[F]?.[A])continue;this.player.x=A*120,this.player.y=F*120;return}this.player.x=0,this.player.y=0}initNPCs(){if(this.dogImg){let E=Math.floor(3.6666666666666665),M,_;if(this.playerOnLeft)M=11-E-1,_=10;else M=0,_=E;this.spawnNPC(this.dogImg,"dog",M,_)}if(this.chickImg){let E=4+Math.floor(Math.random()*2);for(let M=0;M<E;M++)this.spawnNPC(this.chickImg,"chick")}}spawnNPC(E,M,_=0,S=10){for(let A=0;A<50;A++){let F=_+Math.floor(Math.random()*(S-_+1)),f=Math.floor(Math.random()*6);if(f<0||f>=6||F<0||F>=11)continue;if(this.wallMatrix[f][F])continue;let D=F*120,B=f*120;if(this.hitboxesOverlap(D,B,this.player.x,this.player.y))continue;let G=!1;for(let q of this.npcs)if(this.hitboxesOverlap(D,B,q.x,q.y)){G=!0;break}if(G)continue;this.npcs.push({x:D,y:B,width:120,height:120,img:E,type:M,dead:!1,wanderTarget:{x:D,y:B},nextWanderTime:0,stuckTime:0,prevX:D,prevY:B,frame:Math.floor(Math.random()*2),lastAnimTime:performance.now()});break}}hitboxesOverlap(E,M,_,S){let A=E+20,F=M+20,f=_+20,D=S+20;return A<f+80&&A+80>f&&F<D+80&&F+80>D}rectsOverlap(E,M,_,S,A,F,f,D){return E<A+f&&E+_>A&&M<F+D&&M+S>F}generateMaze(){this.wallMatrix=[];for(let _=0;_<6;_++)this.wallMatrix.push(Array(11).fill(!1));this.placeIntersectingPair();let E=0,M=0;while(E<6&&M<200){if(this.placeDetachedWall())E++;M++}this.fixClosedBoxes(),console.log(`Placed ${E} detached walls in ${M} attempts`)}fixClosedBoxes(){let E=[];for(let A=0;A<6;A++)E.push(Array(11).fill(!1));let M=-1,_=-1;for(let A=0;A<6&&M<0;A++)for(let F=0;F<11&&_<0;F++)if(!this.wallMatrix[A][F])M=A,_=F;if(M<0)return;let S=[{row:M,col:_}];while(S.length>0){let{row:A,col:F}=S.pop();if(A<0||A>=6||F<0||F>=11)continue;if(E[A][F]||this.wallMatrix[A][F])continue;E[A][F]=!0,S.push({row:A-1,col:F}),S.push({row:A+1,col:F}),S.push({row:A,col:F-1}),S.push({row:A,col:F+1})}for(let A=0;A<6;A++)for(let F=0;F<11;F++)if(!this.wallMatrix[A][F]&&!E[A][F]){this.breakOpenAt(A,F),this.fixClosedBoxes();return}}breakOpenAt(E,M){let _=[{dr:-1,dc:0},{dr:1,dc:0},{dr:0,dc:-1},{dr:0,dc:1}];for(let{dr:S,dc:A}of _){let F=E+S,f=M+A;if(F>=0&&F<6&&f>=0&&f<11){if(this.wallMatrix[F][f]){if(this.getWallSegmentLength(F,f)>2){this.wallMatrix[F][f]=!1;return}}}}for(let{dr:S,dc:A}of _){let F=E+S,f=M+A;if(F>=0&&F<6&&f>=0&&f<11){if(this.wallMatrix[F][f]){let D=this.getWallSegment(F,f);if(D&&this.canSlideWall(D,S,A)){this.slideWall(D,S,A);return}}}}for(let{dr:S,dc:A}of _){let F=E+S,f=M+A;if(F>=0&&F<6&&f>=0&&f<11){if(this.wallMatrix[F][f]){let D=this.getWallSegment(F,f);if(D){for(let B of D)this.wallMatrix[B.row][B.col]=!1;this.placeDetachedWall();return}}}}}getWallSegment(E,M){if(!this.wallMatrix[E][M])return null;let _=[{row:E,col:M}],S=M>0&&this.wallMatrix[E][M-1],A=M<10&&this.wallMatrix[E][M+1],F=E>0&&this.wallMatrix[E-1][M],f=E<5&&this.wallMatrix[E+1][M],D=S||A,B=F||f;if(D&&B)return null;if(D){for(let G=M-1;G>=0&&this.wallMatrix[E][G];G--)_.push({row:E,col:G});for(let G=M+1;G<11&&this.wallMatrix[E][G];G++)_.push({row:E,col:G})}else if(B){for(let G=E-1;G>=0&&this.wallMatrix[G][M];G--)_.push({row:G,col:M});for(let G=E+1;G<6&&this.wallMatrix[G][M];G++)_.push({row:G,col:M})}return _}canSlideWall(E,M,_){for(let S of E){let A=S.row+M,F=S.col+_;if(A<0||A>=6||F<0||F>=11)return!1;let f=[{r:A-1,c:F},{r:A+1,c:F},{r:A,c:F-1},{r:A,c:F+1}];for(let D of f)if(D.r>=0&&D.r<6&&D.c>=0&&D.c<11){if(this.wallMatrix[D.r][D.c]){if(!E.some((G)=>G.row===D.r&&G.col===D.c))return!1}}}return!0}slideWall(E,M,_){for(let S of E)this.wallMatrix[S.row][S.col]=!1;for(let S of E){let A=S.row+M,F=S.col+_;this.wallMatrix[A][F]=!0}}getWallSegmentLength(E,M){if(!this.wallMatrix[E][M])return 0;let _=M>0&&this.wallMatrix[E][M-1]||M<10&&this.wallMatrix[E][M+1],S=E>0&&this.wallMatrix[E-1][M]||E<5&&this.wallMatrix[E+1][M],A=1;if(_&&!S){for(let F=M-1;F>=0&&this.wallMatrix[E][F];F--)A++;for(let F=M+1;F<11&&this.wallMatrix[E][F];F++)A++}else if(S&&!_){for(let F=E-1;F>=0&&this.wallMatrix[F][M];F--)A++;for(let F=E+1;F<6&&this.wallMatrix[F][M];F++)A++}else A=Math.max(A,2);return A}placeIntersectingPair(){for(let F=2;F<5;F++)this.wallMatrix[2][F]=!0;let A=3;for(let F=1;F<=3;F++)this.wallMatrix[F][A]=!0}placeDetachedWall(){let E=Math.random()<0.5,M=2+Math.floor(Math.random()*4),_,S,A=[];if(E){let F=10-M;if(F<1)return!1;_=1+Math.floor(Math.random()*F),S=1+Math.floor(Math.random()*4);for(let f=_;f<_+M;f++)A.push({row:S,col:f})}else{let F=5-M;if(F<1)return!1;S=1+Math.floor(Math.random()*F),_=1+Math.floor(Math.random()*9);for(let f=S;f<S+M;f++)A.push({row:f,col:_})}for(let F of A)if(this.touchesAnyWall(F.row,F.col))return!1;for(let F of A)this.wallMatrix[F.row][F.col]=!0;return!0}touchesAnyWall(E,M){if(this.wallMatrix[E][M])return!0;if(E>0&&this.wallMatrix[E-1][M])return!0;if(E<5&&this.wallMatrix[E+1][M])return!0;if(M>0&&this.wallMatrix[E][M-1])return!0;if(M<10&&this.wallMatrix[E][M+1])return!0;return!1}isWall(E,M){if(E<0||E>=6||M<0||M>=11)return!1;return this.wallMatrix[E][M]}getTileIndex(E,M){let _=this.isWall(E-1,M),S=this.isWall(E+1,M),A=this.isWall(E,M-1),F=this.isWall(E,M+1),f=_||S,D=A||F;if(f&&D)return 4;if(f)if(_&&S)return 0;else if(S)return 1;else return 6;if(D)if(A&&F)return 2;else if(F)return 3;else return 5;return 4}renderMapToBuffer(){if(this.mapCanvas=new OffscreenCanvas(1320,720),this.mapCtx=this.mapCanvas.getContext("2d"),this.grassImg){let E=this.grassImg.width,M=this.grassImg.height;for(let _=0;_<720;_+=M)for(let S=0;S<1320;S+=E)this.mapCtx.drawImage(this.grassImg,S,_)}}update(E,M){if(E.fillStyle="#000000",E.fillRect(0,0,E.canvas.width,E.canvas.height),this.grassImg){E.globalAlpha=0.3;let G=this.grassImg.width,q=this.grassImg.height;for(let I=0;I<E.canvas.height;I+=q)for(let T=0;T<E.canvas.width;T+=G)E.drawImage(this.grassImg,T,I);E.globalAlpha=1}if(E.save(),E.translate(this.offsetX,this.offsetY),E.scale(this.scale,this.scale),E.beginPath(),E.rect(0,0,426,720),E.clip(),!this.loadingScreenDismissed){if(this.grassImg){let $=this.grassImg.width,L=this.grassImg.height;for(let J=0;J<720;J+=L)for(let K=0;K<426;K+=$)E.drawImage(this.grassImg,K,J,$+1,L+1)}else E.fillStyle="#1a1a1a",E.fillRect(0,0,426,720);let G=300,q=20,I=(426-G)/2,T=360;if(E.fillStyle="#333",E.fillRect(I,T,G,q),E.fillStyle="#4a4",E.fillRect(I,T,G*this.loadingProgress,q),E.strokeStyle="#666",E.lineWidth=2,E.strokeRect(I,T,G,q),E.fillStyle="#fff",E.font="24px monospace",E.textAlign="center",this.loadingComplete)E.fillText("Tap to Continue",213,T+60);else E.fillText("Loading...",213,T+60);E.restore();return}if(!this.gameStarted){if(E.clearRect(0,0,426,720),this.titleImg)E.drawImage(this.titleImg,0,0,426,720);E.restore();return}if(!this.mapCanvas){E.restore();return}let _=performance.now(),S=250;if(_-this.lastAnimTime>=S)this.player.frame=(this.player.frame+1)%2,this.lastAnimTime=_;let A=250;for(let G of this.npcs)if(!G.dead&&_-G.lastAnimTime>=A)G.frame=(G.frame+1)%2,G.lastAnimTime=_;if(!this.gameOver&&!this.levelComplete){let G=this.player.x,q=this.player.y;if(this.keys.has("ArrowLeft"))G-=8;if(this.keys.has("ArrowRight"))G+=8;if(this.keys.has("ArrowUp"))q-=8;if(this.keys.has("ArrowDown"))q+=8;if(this.mouseTarget&&this.isMouseDown){let I=this.mouseTarget.x-(this.player.x+this.player.width/2),T=this.mouseTarget.y-(this.player.y+this.player.height/2),$=Math.sqrt(I*I+T*T);if($>10)G=this.player.x+I/$*8,q=this.player.y+T/$*8}if(!this.collidesWithWall(G,this.player.y))this.player.x=G;if(!this.collidesWithWall(this.player.x,q))this.player.y=q;this.player.x=Math.max(0,Math.min(this.player.x,1320-this.player.width)),this.player.y=Math.max(0,Math.min(this.player.y,720-this.player.height)),this.updateNPCs(performance.now()),this.checkChickCollisions(),this.checkDogCollision()}this.cameraX=this.player.x+this.player.width/2-213,this.cameraY=this.player.y+this.player.height/2-360,this.cameraX=Math.max(0,Math.min(this.cameraX,894)),this.cameraY=Math.max(0,Math.min(this.cameraY,0)),E.clearRect(0,0,426,720),E.drawImage(this.mapCanvas,this.cameraX,this.cameraY,426,720,0,0,426,720),E.globalCompositeOperation="source-over",E.font="bold 24px sans-serif",E.textAlign="left",E.textBaseline="top";let F="Score: ",f=`${this.score}`,D=12+E.measureText(F).width;E.shadowColor="rgba(0, 0, 0, 1)",E.shadowBlur=8,E.shadowOffsetX=0,E.shadowOffsetY=0,E.fillStyle="#ff5555",E.fillText(F,12,40),E.fillStyle="#ffffff",E.fillText(f,D,40),E.font="14px sans-serif",E.fillStyle="#ffffff",E.fillText(`High Score: ${this.highScore}`,12,68),E.shadowColor="transparent",E.shadowBlur=0;let B=[];if(this.bushesImg){for(let G=0;G<6;G++)for(let q=0;q<11;q++)if(this.wallMatrix[G][q]){let I=this.getTileIndex(G,q);B.push({type:"bush",img:this.bushesImg,x:q*120,y:G*120,tileIndex:I})}}if(this.foxImg)B.push({type:"player",img:this.foxImg,x:this.player.x,y:this.player.y});for(let G of this.npcs)if(G.dead)B.push({type:"bone",img:G.img,x:G.x,y:G.y});else B.push({type:"npc",img:G.img,x:G.x,y:G.y,frame:G.frame});B.sort((G,q)=>G.y-q.y);for(let G of B){let q=G.x-this.cameraX,I=G.y-this.cameraY;if(G.type==="bush"&&G.tileIndex!==void 0)E.drawImage(G.img,G.tileIndex*120,0,120,120,q,I,120,120);else if(G.type==="player")E.fillStyle="rgba(0, 0, 0, 0.25)",E.beginPath(),E.ellipse(q+60,I+120-10,22,8,0,0,Math.PI*2),E.fill(),E.drawImage(G.img,this.player.frame*120,0,120,120,q,I,120,120);else if(G.type==="npc"&&G.frame!==void 0)E.fillStyle="rgba(0, 0, 0, 0.25)",E.beginPath(),E.ellipse(q+60,I+120-15,22,8,0,0,Math.PI*2),E.fill(),E.drawImage(G.img,G.frame*120,0,120,120,q,I,120,120);else if(G.type==="bone")E.fillStyle="rgba(0, 0, 0, 0.25)",E.beginPath(),E.ellipse(q+60,I+120-24,55,10,0,0,Math.PI*2),E.fill(),E.drawImage(G.img,q,I,120,120);else E.drawImage(G.img,q,I,120,120)}if(this.gameOver)E.fillStyle="rgba(0, 0, 0, 0.6)",E.fillRect(0,0,426,720),E.fillStyle="#ff5555",E.font="bold 48px sans-serif",E.textAlign="center",E.textBaseline="middle",E.fillText("Game Over",213,330),E.fillStyle="#ffffff",E.font="24px sans-serif",E.fillText("Tap to Retry",213,390);if(this.levelComplete)E.fillStyle="rgba(0, 0, 0, 0.6)",E.fillRect(0,0,426,720),E.fillStyle="#55ff55",E.font="bold 48px sans-serif",E.textAlign="center",E.textBaseline="middle",E.fillText("Level Complete",213,330),E.fillStyle="#ffffff",E.font="24px sans-serif",E.fillText("Tap to Continue",213,390);E.restore()}collidesWithWall(E,M){let _=E+20,S=M+20,A=Math.floor(_/120),F=Math.floor((_+80-1)/120),f=Math.floor(S/120),D=Math.floor((S+80-1)/120);for(let B=f;B<=D;B++)for(let G=A;G<=F;G++)if(this.wallMatrix[B]?.[G]){let q=G*120+20,I=B*120+20;if(_<q+80&&_+80>q&&S<I+80&&S+80>I)return!0}for(let B of this.npcs)if(!B.dead&&B.type!=="chick"&&this.hitboxesOverlap(E,M,B.x,B.y))return!0;return!1}checkChickCollisions(){for(let E of this.npcs)if(E.type==="chick"&&!E.dead){if(this.hitboxesOverlap(this.player.x,this.player.y,E.x,E.y)){if(E.dead=!0,this.score++,this.score>this.highScore)this.highScore=this.score,this.saveHighScore();if(this.chickBonesImg)E.img=this.chickBonesImg;if(this.cluckSound)this.cluckSound.currentTime=0,this.cluckSound.play();if(this.npcs.filter((_)=>_.type==="chick"&&!_.dead).length===0)this.levelComplete=!0}}}checkDogCollision(){for(let E of this.npcs)if(E.type==="dog"&&!E.dead){if(this.hitboxesOverlap(this.player.x,this.player.y,E.x,E.y)){if(this.gameOver=!0,this.introSound)this.introSound.currentTime=0,this.introSound.play();return}}}updateNPCs(E){let M=this.getSpeedMultiplier();for(let _ of this.npcs){if(_.dead)continue;let S=this.hasLineOfSight(_.x,_.y,this.player.x,this.player.y),A=this.player.x-_.x,F=this.player.y-_.y,f=Math.sqrt(A*A+F*F);if(_.type==="chick")if(S)this.moveNpcAway(_,this.player.x,this.player.y,5*M);else this.wanderNpc(_,E,2*M);else if(_.type==="dog")if(S&&f<300){if(this.moveNpcToward(_,this.player.x,this.player.y,5*M),this.barkSound&&E-this.lastBarkTime>=4000)this.barkSound.currentTime=0,this.barkSound.play(),this.lastBarkTime=E}else this.wanderNpc(_,E,3*M);if(_.x=Math.max(0,Math.min(_.x,1320-_.width)),_.y=Math.max(0,Math.min(_.y,720-_.height)),Math.abs(_.x-_.prevX)+Math.abs(_.y-_.prevY)<0.5)_.stuckTime++;else _.stuckTime=0;_.prevX=_.x,_.prevY=_.y}}wanderNpc(E,M,_){let S=E.wanderTarget.x-E.x,A=E.wanderTarget.y-E.y;if(Math.sqrt(S*S+A*A)<20||M>E.nextWanderTime||E.stuckTime>15)this.pickRandomWanderTarget(E),E.nextWanderTime=M+1000+Math.random()*1000,E.stuckTime=0;this.moveNpcToward(E,E.wanderTarget.x,E.wanderTarget.y,_)}pickRandomWanderTarget(E){for(let M=0;M<20;M++){let _=Math.floor(Math.random()*11),S=Math.floor(Math.random()*6);if(S>=0&&S<6&&_>=0&&_<11){if(!this.wallMatrix[S][_]){E.wanderTarget.x=_*120,E.wanderTarget.y=S*120;return}}}}moveNpcToward(E,M,_,S){let A=M-E.x,F=_-E.y,f=Math.sqrt(A*A+F*F);if(f<1)return;let D=A/f*S,B=F/f*S,G=E.x+D,q=E.y+B;if(!this.npcCollidesWithWall(E,G,E.y))E.x=G;if(!this.npcCollidesWithWall(E,E.x,q))E.y=q}moveNpcAway(E,M,_,S){let A=E.x-M,F=E.y-_,f=Math.sqrt(A*A+F*F);if(f<1)return;let D=A/f*S,B=F/f*S,G=20,q=!1;if(E.x<=G&&D<0)D=0,q=!0;if(E.x>=1320-E.width-G&&D>0)D=0,q=!0;if(E.y<=G&&B<0)B=0,q=!0;if(E.y>=720-E.height-G&&B>0)B=0,q=!0;if(q||E.stuckTime>5){let $=S*0.8;D+=(Math.random()-0.5)*$*2,B+=(Math.random()-0.5)*$*2}let I=E.x+D,T=E.y+B;if(!this.npcCollidesWithWall(E,I,E.y))E.x=I;if(!this.npcCollidesWithWall(E,E.x,T))E.y=T}npcCollidesWithWall(E,M,_){let S=M+20,A=_+20,F=Math.floor(S/120),f=Math.floor((S+80-1)/120),D=Math.floor(A/120),B=Math.floor((A+80-1)/120);for(let G=D;G<=B;G++)for(let q=F;q<=f;q++)if(this.wallMatrix[G]?.[q]){let I=q*120+20,T=G*120+20;if(S<I+80&&S+80>I&&A<T+80&&A+80>T)return!0}return!1}hasLineOfSight(E,M,_,S){let A=E+60,F=M+60,f=_+60,D=S+60,B=f-A,G=D-F,q=Math.sqrt(B*B+G*G),I=Math.max(1,Math.floor(q/20));for(let T=0;T<=I;T++){let $=T/I,L=A+B*$,J=F+G*$,K=Math.floor(L/120),j=Math.floor(J/120);if(this.wallMatrix[j]?.[K])return!1}return!0}}var U=new Q("game");await U.setScene(new Z);U.start();
